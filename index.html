<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WriteFlow by Ashiful</title>
    <!-- jsPDF Library for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Marked Library for Markdown Rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- TypeScript Compiler -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/typescript/4.7.4/typescript.min.js"></script>
    <!-- Pyodide (Python Runtime) -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.22.1/full/pyodide.js"></script>
    <!-- sql.js (SQL Engine) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-asm.js"></script>
    <!-- php-wasm (PHP Runtime) -->
    <script src="https://cdn.jsdelivr.net/npm/php-wasm/php-wasm.js"></script>


<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon-512.png" type="image/png">
<meta name="theme-color" content="#ffffff">


    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6e9cd2;
            --light-bg: #f8f9fa;
            --dark-bg: #1e2124;
            --light-text: #333;
            --dark-text: #f0f0f0;
            --light-container: #ffffff;
            --dark-container: #2c2f33;
            --border-radius: 6px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            --error-color: #d9534f;
            --suggestion-color: #5bc0de;
        }
        * { box-sizing: border-box; transition: background-color 0.3s, color 0.3s; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; background: var(--light-bg); color: var(--light-text); }
        body.night-mode { background: var(--dark-bg); color: var(--dark-text); }
        .container { width: 90%; max-width: 900px; background: var(--light-container); padding: 20px; box-shadow: var(--box-shadow); border-radius: var(--border-radius); display: flex; flex-direction: column; height: 90vh; }
        body.night-mode .container { background: var(--dark-container); color: var(--dark-text); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #e0e0e0; }
        body.night-mode .header { border-bottom: 1px solid #555; }
        .title-bar { font-size: 22px; font-weight: bold; display: flex; align-items: center; }
        .title-bar svg { margin-right: 10px; fill: var(--primary-color); }
        .file-tabs { display: flex; margin-bottom: 5px; border-bottom: 1px solid #e0e0e0; flex-wrap: wrap; }
        .file-tab { padding: 8px 12px; cursor: pointer; border: 1px solid transparent; border-bottom: none; position: relative; background: #f1f1f1; }
        .file-tab.active { background: var(--light-container); border-color: #e0e0e0; border-bottom: 1px solid var(--light-container); }
        body.night-mode .file-tab { background: #333; }
        body.night-mode .file-tab.active { background: var(--dark-container); border-color: #555; border-bottom: 1px solid var(--dark-container); }
        .file-tab .close-tab { margin-left: 8px; cursor: pointer; font-weight: bold; }
        .toolbar { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .button-group { display: flex; border-radius: var(--border-radius); overflow: hidden; }
        button { padding: 8px 12px; border: none; background: var(--primary-color); color: white; cursor: pointer; font-size: 14px; display: flex; align-items: center; transition: background 0.2s; }
        button:hover { background: var(--secondary-color); }
        button svg { margin-right: 5px; width: 16px; height: 16px; }
        .menu { position: relative; }
        .menu-content { display: none; position: absolute; right: 0; top: 100%; background: var(--light-container); box-shadow: var(--box-shadow); z-index: 10; min-width: 180px; border-radius: var(--border-radius); padding: 8px 0; }
        body.night-mode .menu-content { background: var(--dark-container); }
        .menu.active .menu-content { display: block; }
        .menu-content button { width: 100%; text-align: left; background: none; color: var(--light-text); padding: 10px 15px; border-radius: 0; }
        body.night-mode .menu-content button { color: var(--dark-text); }
        .menu-content button:hover { background: rgba(0, 0, 0, 0.05); }
        body.night-mode .menu-content button:hover { background: rgba(255, 255, 255, 0.05); }
        .editor-container { flex: 1; position: relative; display: flex; overflow: hidden; border: 1px solid #e0e0e0; border-radius: var(--border-radius); }
        body.night-mode .editor-container { border-color: #555; }
        textarea { width: 100%; height: 100%; border: none; resize: none; font-size: 16px; outline: none; padding: 15px; background: transparent; color: inherit; overflow: auto; line-height: 1.5; }
        .status-bar { display: flex; justify-content: space-between; padding: 10px 0; font-size: 13px; color: #666; margin-top: 10px; }
        body.night-mode .status-bar { color: #aaa; }
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 99; }
        .find-replace-container, .pdf-preview-modal, .code-execute-modal, .grammar-modal { display: none; position: fixed; background: var(--light-container); box-shadow: var(--box-shadow); border-radius: var(--border-radius); z-index: 100; flex-direction: column; }
        .find-replace-container { top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 15px; width: 350px; }
        .pdf-preview-modal, .code-execute-modal, .grammar-modal { top: 5%; left: 5%; width: 90%; height: 90%; padding: 20px; }
        body.night-mode .find-replace-container, body.night-mode .pdf-preview-modal, body.night-mode .code-execute-modal, body.night-mode .grammar-modal { background: var(--dark-container); }
        .pdf-preview-header, .code-execute-header, .grammar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #e0e0e0; }
        body.night-mode .pdf-preview-header, body.night-mode .code-execute-header, body.night-mode .grammar-header { border-bottom-color: #555; }
        .pdf-preview-content { flex: 1; overflow: auto; border: 1px solid #e0e0e0; margin-bottom: 15px; padding: 20px; background: white; color: black; display: flex; flex-direction: column; align-items: center; }
        .code-execute-content, .grammar-content { flex: 1; display: flex; overflow: auto; margin-bottom: 15px; border: 1px solid #e0e0e0; border-radius: var(--border-radius); padding: 15px; }
        body.night-mode .code-execute-content, body.night-mode .grammar-content { border-color: #555; }
        .pdf-preview-title { text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 20px; }
        .pdf-preview-body { font-size: 16px; line-height: 1.5; white-space: pre-wrap; text-align: left; width: 100%; }
        .pdf-preview-footer, .code-execute-footer, .grammar-footer { display: flex; justify-content: flex-end; gap: 10px; }
        .code-output { width: 100%; height: 100%; flex-grow: 1; background: #f5f5f5; display: flex; align-items: center; justify-content: center; }
        body.night-mode .code-output { background: #2a2a2a; color: lightgray; }
        .code-output.text-mode { padding: 15px; align-items: flex-start; justify-content: flex-start; white-space: pre-wrap; font-family: monospace; overflow: auto; }
        .preview-toolbar { display: none; align-items: center; gap: 8px; flex-wrap: wrap; justify-content: center; flex-grow: 1; margin: 0 15px; }
        .preview-toolbar input[type="text"] { width: 65px; padding: 4px; font-size: 12px; }
        .preview-toolbar button { padding: 4px 8px; font-size: 12px; }
        .editor-container.show-line-numbers { display: flex; }
        .line-numbers { display: none; width: 40px; padding: 15px 5px; background-color: rgba(0, 0, 0, 0.03); border-right: 1px solid #e0e0e0; text-align: right; color: #888; font-size: 16px; line-height: 1.5; overflow: hidden; user-select: none; }
        body.night-mode .line-numbers { background-color: rgba(255, 255, 255, 0.03); border-right-color: #555; }
        .editor-container.show-line-numbers .line-numbers { display: block; }
        .editor-container.show-line-numbers textarea { width: calc(100% - 40px); }
        .grammar-issue { border-bottom: 2px solid var(--error-color); padding: 8px; margin-bottom: 12px; }
        .grammar-context { font-style: italic; color: #666; }
        body.night-mode .grammar-context { color: #aaa; }
        .grammar-message { font-weight: bold; margin: 4px 0; }
        .grammar-suggestion { color: var(--suggestion-color); cursor: pointer; text-decoration: underline; margin-right: 10px; }
        @media print { body, .container { height: auto; overflow: visible; background: white; color: black; box-shadow: none; } .header, .toolbar, .status-bar, .menu { display: none; } .editor-container { border: none; overflow: visible; height: auto; } textarea { height: auto; white-space: pre-wrap; overflow: visible; color: black; } .line-numbers { display: none; } }
    </style>
</head>
<body>
    <div class="modal-backdrop" id="modalBackdrop"></div>

    <div class="container">
        <div class="header">
            <div class="title-bar">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                WriteFlow by Ashiful
            </div>
            <div class="menu">
                <button id="menuButton" style="border-radius:5px"  onclick="toggleMenu()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg> Features
                </button>
                <div class="menu-content" id="menuOptions">
                    <button onclick="toggleNightMode()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg> Night Mode</button>
                    <button onclick="zoomIn()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg> Zoom In</button>
                    <button onclick="zoomOut()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg> Zoom Out</button>
                    <button onclick="openFindReplace()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg> Find & Replace</button>
                    <button onclick="renameFile()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg> Rename File</button>
                    <button onclick="printDocument()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg> Print as PDF</button>
                    <button onclick="toggleLineNumbers()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg> Line Numbers</button>
                    <button onclick="executeCode()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg> Execute Code</button>
                    <button onclick="openGrammarModal()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg> Grammar & Spell Check</button>
                    <button onclick="undo()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"></path><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path></svg> Undo</button>
                    <button onclick="redo()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 7v6h-6"></path><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7"></path></svg> Redo</button>
                    <button onclick="speakText()" id="speakButton"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg> Text to Speech</button>
                </div>
            </div>
        </div>

        <div class="toolbar">
            <div class="button-group">
                <button onclick="saveFile()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Save</button>
                <button onclick="openFileDialog()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg> Open</button>
                <button onclick="newFile()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg> New File</button>
            </div>
            <div class="button-group">
                <button onclick="clearEditor()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg> Clear</button>
            </div>
        </div>
        
        <div class="file-tabs" id="fileTabs"></div>

        <div class="editor-container" id="editorContainer">
            <div class="line-numbers" id="lineNumbers"></div>
            <textarea id="editor" oninput="handleEditorInput()" onscroll="syncScroll()" placeholder="Start typing here..."></textarea>
        </div>

        <div class="status-bar">
            <div class="word-count" id="wordCount">Words: 0 | Chars: 0 | Lines: 0</div>
            <div id="fileInfo">text.txt</div>
        </div>
    </div>

    <div class="find-replace-container" id="findReplace">
        <input type="text" id="findText" placeholder="Find text" style="width:100%; margin-bottom:10px;">
        <input type="text" id="replaceText" placeholder="Replace with" style="width:100%; margin-bottom:10px;">
        <div style="display:flex; flex-wrap: wrap; gap: 5px; justify-content:space-between;">
            <button onclick="findPrevious()" style="flex-grow: 1;">Previous</button>
            <button onclick="findNext()" style="flex-grow: 1;">Next</button>
            <button onclick="replaceText()" style="flex-grow: 1;">Replace</button>
            <button onclick="replaceAllText()" style="flex-grow: 1;">Replace All</button>
            <button onclick="closeFindReplace()" style="flex-basis: 100%; margin-top: 5px;">Close</button>
        </div>
    </div>

    <div class="pdf-preview-modal" id="pdfPreviewModal">
        <div class="pdf-preview-header"><h3>PDF Preview</h3><button onclick="closePdfPreview()">X</button></div>
        <div class="pdf-preview-content" id="pdfPreviewContent">
            <h2 class="pdf-preview-title" id="pdfTitle"></h2>
            <pre class="pdf-preview-body" id="pdfBody"></pre>
        </div>
        <div class="pdf-preview-footer"><button onclick="downloadPdf()">Download PDF</button><button onclick="printPdf()">Print</button></div>
    </div>

    <div class="code-execute-modal" id="codeExecuteModal">
        <div class="code-execute-header">
            <h3>Execution</h3>
            <div id="htmlPreviewToolbar" class="preview-toolbar">
                <span>Preview:</span>
                <button onclick="setPreviewSize('375px', '667px')">Phone</button>
                <button onclick="setPreviewSize('768px', '1024px')">Tablet</button>
                <button onclick="setPreviewSize('100%', '100%')">PC</button>
                <input type="text" id="customWidth" placeholder="Width">
                <input type="text" id="customHeight" placeholder="H (auto)">
                <button onclick="setCustomPreviewSize()">Set</button>
            </div>
            <button onclick="closeCodeExecuteModal()">X</button>
        </div>
        <div class="code-execute-content"><div id="codeOutput" class="code-output"></div></div>
        <div class="code-execute-footer"><button onclick="closeCodeExecuteModal()">Close</button></div>
    </div>
    
    <div class="grammar-modal" id="grammarModal">
        <div class="grammar-header">
            <h3>Grammar & Spell Check</h3>
            <button onclick="closeGrammarModal()">X</button>
        </div>
        <div class="grammar-content">
            <div id="grammarOutput" style="font-family: sans-serif; width: 100%; align-self: flex-start;">Click "Check Text" to begin.</div>
        </div>
        <div class="grammar-footer">
            <button onclick="runGrammarCheck()">Check Text</button>
            <button onclick="closeGrammarModal()">Close</button>
        </div>
    </div>

    <input type="file" id="fileInput" style="display: none" multiple>
    <!-- Hidden fields for non-UI data -->
    <input type="hidden" id="fileName"><input type="hidden" id="fileExt">

    <script>
        const editor = document.getElementById('editor');
        const fileTabsContainer = document.getElementById('fileTabs');
        const fileName = document.getElementById('fileName');
        const fileExt = document.getElementById('fileExt');
        const modalBackdrop = document.getElementById('modalBackdrop');
        const findReplaceDialog = document.getElementById('findReplace');
        const codeExecuteModal = document.getElementById('codeExecuteModal');
        const pdfPreviewModal = document.getElementById('pdfPreviewModal');
        const grammarModal = document.getElementById('grammarModal');
        const wordCountElement = document.getElementById('wordCount');
        const fileInfoElement = document.getElementById('fileInfo');
        const codeOutputElement = document.getElementById('codeOutput');
        const grammarOutputElement = document.getElementById('grammarOutput');
        const lineNumbersElement = document.getElementById('lineNumbers');
        const fileInput = document.getElementById('fileInput');
        const menu = document.querySelector('.menu');

        let currentFontSize = 16;
        let undoStack = [""];
        let redoStack = [];
        let lineNumbersEnabled = false;
        let isSpeaking = false;
        let files = {};
        let activeFile = null;
        let pyodide = null;

        document.addEventListener('DOMContentLoaded', () => {
            initializeDefaultFile();
            document.addEventListener('keydown', handleKeydown);
            fileInput.addEventListener('change', openFiles);
            document.addEventListener('click', (event) => {
                if (!menu.contains(event.target)) {
                    menu.classList.remove('active');
                }
            });
        });

        function vibrate(duration = 20) {
            if (navigator.vibrate) navigator.vibrate(duration);
        }

        function toggleMenu() {
            vibrate();
            menu.classList.toggle('active');
        }

        function initializeDefaultFile() {
            files = { "text.txt": { content: `Welcome to WriteFlow!\n\nThis text have some errrors. Try the grammar checker.`, extension: "txt" } };
            switchFile("text.txt");
        }

        function handleKeydown(e) {
            if (e.ctrlKey) {
                const keyMap = { 's': saveFile, 'o': openFileDialog, 'z': undo, 'y': redo, 'f': openFindReplace, 'p': printDocument };
                if (keyMap[e.key]) { e.preventDefault(); keyMap[e.key](); }
            }
        }

        function handleEditorInput() {
            if (activeFile) files[activeFile].content = editor.value;
            updateStats();
            updateLineNumbers();
            if (undoStack[undoStack.length - 1] !== editor.value) {
                undoStack.push(editor.value);
                if (undoStack.length > 50) undoStack.shift();
                redoStack = [];
            }
        }

        function renderFileTabs() {
            fileTabsContainer.innerHTML = '';
            Object.keys(files).forEach(filename => {
                const tab = document.createElement('div');
                tab.className = 'file-tab' + (filename === activeFile ? ' active' : '');
                tab.textContent = filename;
                tab.onclick = () => { vibrate(); switchFile(filename); };
                const closeBtn = document.createElement('span');
                closeBtn.className = 'close-tab';
                closeBtn.innerHTML = '&times;';
                closeBtn.onclick = (e) => { e.stopPropagation(); vibrate(); closeFile(filename); };
                tab.appendChild(closeBtn);
                fileTabsContainer.appendChild(tab);
            });
        }

        function switchFile(filename) {
            if (activeFile && files[activeFile]) files[activeFile].content = editor.value;
            activeFile = filename;
            const file = files[filename];
            editor.value = file.content;
            const nameParts = filename.split('.');
            fileExt.value = file.extension;
            fileName.value = nameParts.length > 1 ? nameParts.slice(0, -1).join('.') : filename;
            undoStack = [file.content]; redoStack = [];
            renderFileTabs();
            updateStats();
            updateLineNumbers();
        }

        function newFile() {
            vibrate();
            const filename = prompt("Enter new filename (e.g., script.py):");
            if (!filename) return;
            if (files[filename]) { alert("File already exists."); return; }
            const nameParts = filename.split('.');
            files[filename] = { content: '', extension: nameParts.length > 1 ? nameParts[nameParts.length - 1] : 'txt' };
            switchFile(filename);
        }

        function closeFile(filename) {
            if (Object.keys(files).length <= 1) { alert("Cannot close the last file."); return; }
            delete files[filename];
            if (activeFile === filename) switchFile(Object.keys(files)[0]);
            renderFileTabs();
        }

        function renameFile() {
            vibrate();
            if (!activeFile) { alert("No active file to rename."); return; }
            const oldFilename = activeFile;
            const newFilename = prompt("Enter the new filename:", oldFilename);
            if (!newFilename || newFilename === oldFilename) return;
            if (files[newFilename]) { alert("A file with this name already exists."); return; }
            files[newFilename] = files[oldFilename];
            files[newFilename].content = editor.value; 
            const nameParts = newFilename.split('.');
            files[newFilename].extension = nameParts.length > 1 ? nameParts[nameParts.length - 1].toLowerCase() : 'txt';
            delete files[oldFilename];
            switchFile(newFilename);
        }

        function updateStats() {
            const text = editor.value;
            const wordCount = text.trim() ? text.trim().split(/\s+/).length : 0;
            wordCountElement.textContent = `Words: ${wordCount} | Chars: ${text.length} | Lines: ${text.split('\n').length}`;
            fileInfoElement.textContent = activeFile || 'No file selected';
        }
        
        function undo() { vibrate(); if (undoStack.length > 1) { redoStack.push(undoStack.pop()); editor.value = undoStack[undoStack.length - 1] || ""; updateAll(); } }
        function redo() { vibrate(); if (redoStack.length > 0) { undoStack.push(redoStack.pop()); editor.value = undoStack[undoStack.length - 1] || ""; updateAll(); } }
        function updateAll() { if (activeFile) files[activeFile].content = editor.value; updateStats(); updateLineNumbers(); }
        
        function saveFile() {
            vibrate(); if (!activeFile) return;
            const blob = new Blob([files[activeFile].content], { type: 'text/plain;charset=utf-8' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = activeFile;
            a.click(); URL.revokeObjectURL(a.href);
        }

        function openFileDialog() { vibrate(); fileInput.click(); }
        function openFiles(event) {
            vibrate();
            Array.from(event.target.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const nameParts = file.name.split('.');
                    files[file.name] = { content: e.target.result, extension: nameParts.length > 1 ? nameParts[nameParts.length-1].toLowerCase() : 'txt' };
                    switchFile(file.name);
                };
                reader.readAsText(file);
            });
            fileInput.value = '';
        }

        function clearEditor() { vibrate(); if (confirm('Clear active file?')) { editor.value = ''; updateAll(); } }
        function toggleNightMode() { vibrate(); document.body.classList.toggle('night-mode'); }
        function zoomIn() { vibrate(); editor.style.fontSize = `${(currentFontSize += 2)}px`; updateLineNumbers(); }
        function zoomOut() { vibrate(); if (currentFontSize > 8) editor.style.fontSize = `${(currentFontSize -= 2)}px`; updateLineNumbers(); }

        function syncScroll() { lineNumbersElement.scrollTop = editor.scrollTop; }
        
        function openFindReplace() { vibrate(); findReplaceDialog.style.display = 'flex'; modalBackdrop.style.display = 'block'; }
        function closeFindReplace() { vibrate(); findReplaceDialog.style.display = 'none'; modalBackdrop.style.display = 'none'; }
        
        function findNext() {
            vibrate(); const findTerm = document.getElementById('findText').value; if (!findTerm) return;
            const cursor = editor.selectionEnd;
            let nextIndex = editor.value.indexOf(findTerm, cursor);
            if (nextIndex === -1) { nextIndex = editor.value.indexOf(findTerm); } 
            if (nextIndex !== -1) { editor.setSelectionRange(nextIndex, nextIndex + findTerm.length); }
            editor.focus();
        }

        function findPrevious() {
            vibrate(); const findTerm = document.getElementById('findText').value; if (!findTerm) return;
            const cursor = editor.selectionStart;
            let prevIndex = editor.value.lastIndexOf(findTerm, cursor - findTerm.length);
            if (prevIndex === -1) { prevIndex = editor.value.lastIndexOf(findTerm); }
            if (prevIndex !== -1) { editor.setSelectionRange(prevIndex, prevIndex + findTerm.length); }
            editor.focus();
        }
        
        function replaceText() {
            vibrate();
            const findTerm = document.getElementById('findText').value;
            const replaceTerm = document.getElementById('replaceText').value;
            if (!findTerm) return;
            const currentSelection = editor.value.substring(editor.selectionStart, editor.selectionEnd);
            if (currentSelection.toLowerCase() === findTerm.toLowerCase()) {
                editor.setRangeText(replaceTerm, editor.selectionStart, editor.selectionEnd);
                updateAll();
            }
            findNext();
        }

        function replaceAllText() {
            vibrate(); const findTerm = document.getElementById('findText').value, replaceTerm = document.getElementById('replaceText').value;
            if (!findTerm) return; editor.value = editor.value.split(findTerm).join(replaceTerm); updateAll();
        }

        async function executeCode() {
            vibrate();
            if (!activeFile) return;
            const { extension, content } = files[activeFile];
            
            codeOutputElement.className = 'code-output text-mode';
            codeOutputElement.innerHTML = "Executing...";
            document.getElementById('htmlPreviewToolbar').style.display = 'none';
            codeExecuteModal.style.display = 'flex';
            modalBackdrop.style.display = 'block';
            
            const unsupported = ["java", "cs", "cpp", "c", "asm", "go", "rb", "r", "jl", "rs", "swift", "kt"];
            if (unsupported.includes(extension)) {
                codeOutputElement.innerText = `Direct execution for '.${extension}' files is not supported in the browser.\n\nThis is a client-side editor. Languages like Java, C++, C#, Go, and Rust require a server-side compiler and execution environment, which is beyond the scope of this tool.`;
                return;
            }

            try {
                switch(extension) {
                    case 'html':
                        document.getElementById('htmlPreviewToolbar').style.display = 'flex';
                        codeOutputElement.className = 'code-output';
                        let htmlContent = content.replace(/<link.*?href="(.+?)"/g, (match, file) => files[file] ? `<style>${files[file].content}</style>` : match)
                                                .replace(/<script.*?src="(.+?)"/g, (match, file) => files[file] ? `<script>${files[file].content}<\/script>` : match);
                        const sandbox = document.createElement('iframe');
                        sandbox.style.cssText = 'border: none; transition: width 0.3s ease, height 0.3s ease;';
                        setPreviewSize('100%', '100%');
                        codeOutputElement.innerHTML = '';
                        codeOutputElement.appendChild(sandbox);
                        sandbox.srcdoc = htmlContent;
                        break;
                    case 'js':
                        let jsOutput = [];
                        const i = document.createElement('iframe'); i.style.display = 'none'; document.body.appendChild(i);
                        i.contentWindow.console = { log: (...a) => jsOutput.push(a.join(' ')), error: (...a) => jsOutput.push('ERROR: ' + a.join(' ')) };
                        i.contentWindow.eval(content);
                        document.body.removeChild(i);
                        codeOutputElement.innerText = jsOutput.join('\n') || "Execution finished. No console output.";
                        break;
                    case 'ts':
                        if(!window.ts) { codeOutputElement.innerText = "TypeScript compiler not loaded."; return; }
                        const jsCode = window.ts.transpile(content);
                        let tsOutput = [];
                        const tsIframe = document.createElement('iframe'); tsIframe.style.display = 'none'; document.body.appendChild(tsIframe);
                        tsIframe.contentWindow.console = { log: (...a) => tsOutput.push(a.join(' ')), error: (...a) => tsOutput.push('ERROR: ' + a.join(' ')) };
                        tsIframe.contentWindow.eval(jsCode);
                        document.body.removeChild(tsIframe);
                        codeOutputElement.innerText = tsOutput.join('\n') || "Execution finished. No console output.";
                        break;
                    case 'py':
                        if (!pyodide) {
                            codeOutputElement.innerText = "Initializing Python runtime (Pyodide).\nThis can take up to a minute on first run, please wait...";
                            pyodide = await loadPyodide();
                        }
                        codeOutputElement.innerText = "Executing Python code...";
                        let pyOutput = [];
                        pyodide.setStdout({ batched: (str) => pyOutput.push(str) });
                        pyodide.setStderr({ batched: (str) => pyOutput.push(`ERROR: ${str}`) });
                        let result = await pyodide.runPythonAsync(content);
                        if (result !== undefined && result !== null) {
                             pyOutput.push("Return Value: " + result.toString());
                        }
                        codeOutputElement.innerText = pyOutput.join('\n') || "Execution finished. No output.";
                        break;
                    case 'php':
                        if (typeof PHP === 'undefined') { codeOutputElement.innerText = "PHP-WASM library not loaded."; return; }
                        codeOutputElement.innerText = "Loading PHP runtime...";
                        const php = await new PHP();
                        let phpOutput = '';
                        php.addEventListener('output', (event) => { phpOutput += event.detail.join('\n'); });
                        php.addEventListener('error', (event) => { phpOutput += `ERROR: ${event.detail.join('\n')}`; });
                        await php.run(content);
                        codeOutputElement.innerText = phpOutput || "Execution finished. No output.";
                        break;
                    case 'sql':
                        codeOutputElement.innerText = "Loading SQL engine (sql.js)...";
                        const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}` });
                        const db = new SQL.Database();
                        const results = db.exec(content);
                        let sqlOutput = results.map(res => {
                            let table = `<table style="border-collapse: collapse; width: 100%; color: var(--light-text);"><thead style="background: rgba(0,0,0,0.1);"><tr>${res.columns.map(c => `<th style="padding: 8px; border: 1px solid #ddd;">${c}</th>`).join('')}</tr></thead>`;
                            table += `<tbody>${res.values.map(row => `<tr>${row.map(cell => `<td style="padding: 8px; border: 1px solid #ddd;">${cell}</td>`).join('')}</tr>`).join('')}</tbody></table>`;
                            return table;
                        }).join('<hr style="margin: 20px 0;">');
                        codeOutputElement.innerHTML = sqlOutput || "Execution finished. No results to display.";
                        break;
                    case 'md':
                         if(!window.marked) { codeOutputElement.innerText = "Markdown renderer not loaded."; return; }
                         const mdFrame = document.createElement('iframe');
                         mdFrame.style.cssText = 'width:100%;height:100%;border:none;';
                         codeOutputElement.innerHTML = '';
                         codeOutputElement.appendChild(mdFrame);
                         mdFrame.srcdoc = `<style>body{font-family:sans-serif;padding:20px; color: var(--light-text)} body.night-mode{background:var(--dark-bg)}</style><body class="${document.body.className}">${window.marked.parse(content)}</body>`;
                         break;
                    case 'json':
                        const obj = JSON.parse(content);
                        codeOutputElement.innerText = JSON.stringify(obj, null, 2);
                        break;
                    default:
                        codeOutputElement.innerText = `No execution support for '.${extension}' files. You can edit and save it.`;
                }
            } catch(e) {
                codeOutputElement.innerText = `ERROR: ${e.toString()}\n\nNote: This programming environment runs entirely in your browser. Some features, like file system access (e.g., 'open()'), installing new packages, or certain network requests, may be restricted or unavailable.`;
            }
        }
        
        function setPreviewSize(width, height) {
            vibrate();
            const iframe = codeOutputElement.querySelector('iframe');
            if (iframe) {
                const isPc = width === '100%';
                iframe.style.width = width;
                iframe.style.height = height;
                iframe.style.border = isPc ? 'none' : '1px solid #ccc';
                iframe.style.borderRadius = isPc ? '0' : '8px';
            }
        }

        function setCustomPreviewSize() {
            const width = document.getElementById('customWidth').value;
            let height = document.getElementById('customHeight').value;
            if (width) {
                if (!height) { height = '900'; } // Default height if empty
                setPreviewSize(`${width}px`, `${height}px`);
            } else {
                alert("Please enter a custom width.");
            }
        }

        function closeCodeExecuteModal() { vibrate(); codeExecuteModal.style.display = 'none'; modalBackdrop.style.display = 'none'; }
        function openPdfPreview() { vibrate(); pdfPreviewModal.style.display = 'flex'; modalBackdrop.style.display = 'block'; updatePdfPreview(); }
        function updatePdfPreview() { document.getElementById('pdfTitle').textContent = activeFile || 'Untitled'; document.getElementById('pdfBody').textContent = editor.value; }
        function closePdfPreview() { vibrate(); pdfPreviewModal.style.display = 'none'; modalBackdrop.style.display = 'none'; }

        function generatePdf(action) {
            vibrate();
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') { alert('jsPDF library not loaded.'); return; }
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const title = activeFile || 'Untitled';
                const downloadName = fileName.value || 'document';
                doc.setFontSize(18); doc.text(title, doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
                doc.setFontSize(12);
                const textLines = doc.splitTextToSize(editor.value, doc.internal.pageSize.getWidth() - 40);
                doc.text(textLines, 20, 40);
                if (action === 'download') doc.save(`${downloadName}.pdf`);
                else if (action === 'print') doc.output('dataurlnewwindow');
            } catch (e) { alert("Error generating PDF: " + e.message); }
        }
        function downloadPdf() { generatePdf('download'); }
        function printPdf() { generatePdf('print'); }
        function printDocument() { openPdfPreview(); }

        function toggleLineNumbers() {
            vibrate();
            lineNumbersEnabled = !lineNumbersEnabled;
            document.getElementById('editorContainer').classList.toggle('show-line-numbers', lineNumbersEnabled);
            updateLineNumbers();
        }

        function updateLineNumbers() {
            if (!lineNumbersEnabled) { lineNumbersElement.innerHTML = ''; return; }
            const lines = editor.value.split('\n').length;
            lineNumbersElement.style.fontSize = `${currentFontSize}px`;
            lineNumbersElement.innerHTML = Array.from({ length: lines }, (_, i) => i + 1).join('<br>');
            lineNumbersElement.scrollTop = editor.scrollTop;
        }

        function speakText() {
            vibrate();
            if (!('speechSynthesis' in window)) { alert('Text-to-speech not supported.'); return; }
            if (isSpeaking) { window.speechSynthesis.cancel(); return; }
            if (editor.value.trim() === '') { alert('No text to speak.'); return; }
            const utterance = new SpeechSynthesisUtterance(editor.value);
            const speakButton = document.getElementById('speakButton');
            const originalButtonContent = speakButton.innerHTML;
            utterance.onstart = () => { isSpeaking = true; speakButton.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M6 6h12v12H6z"/></svg> Stop`; };
            const resetBtn = () => { isSpeaking = false; speakButton.innerHTML = originalButtonContent; };
            utterance.onend = resetBtn;
            utterance.onerror = () => { alert('An error occurred during speech.'); resetBtn(); };
            window.speechSynthesis.speak(utterance);
        }

        // --- Grammar and Spell Check Functions ---
        function openGrammarModal() {
            vibrate();
            grammarModal.style.display = 'flex';
            modalBackdrop.style.display = 'block';
            grammarOutputElement.innerHTML = 'Click <strong>Check Text</strong> to analyze the content of the active file using the open-source LanguageTool API.';
        }

        function closeGrammarModal() {
            vibrate();
            grammarModal.style.display = 'none';
            modalBackdrop.style.display = 'none';
        }

        async function runGrammarCheck() {
            vibrate();
            const text = editor.value;
            if (text.trim() === "") {
                grammarOutputElement.innerHTML = "There is no text to check.";
                return;
            }

            grammarOutputElement.innerHTML = "<strong>Checking...</strong>";

            try {
                const response = await fetch('https://api.languagetool.org/v2/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `text=${encodeURIComponent(text)}&language=auto`
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}.`);
                }

                const data = await response.json();
                displayGrammarResults(data);

            } catch (error) {
                grammarOutputElement.innerHTML = `<strong>Error:</strong> Could not connect to the grammar checking service. Please check your internet connection and try again.<br><br><small>${error.message}</small>`;
            }
        }

        function displayGrammarResults(data) {
            if (data.matches.length === 0) {
                grammarOutputElement.innerHTML = "<strong>Excellent! No issues were found.</strong>";
                return;
            }

            let html = `<strong>Found ${data.matches.length} potential issue(s):</strong><br><br>`;
            data.matches.forEach(match => {
                const { offset, length } = match.context;
                const before = match.context.text.substring(0, offset);
                const errorText = match.context.text.substring(offset, offset + length);
                const after = match.context.text.substring(offset + length);

                html += `<div class="grammar-issue">`;
                html += `<div class="grammar-message">${match.message} (${match.rule.category.name})</div>`;
                html += `<div class="grammar-context">..."${before}<strong style="color:var(--error-color)">${errorText}</strong>${after}"...</div>`;

                if (match.replacements.length > 0) {
                    html += `<div><strong>Suggestions:</strong> `;
                    match.replacements.forEach(rep => {
                        html += `<span class="grammar-suggestion">${rep.value}</span> `;
                    });
                    html += `</div>`;
                }
                html += `</div>`;
            });
            grammarOutputElement.innerHTML = html;
        }

    </script>
</body>
</html>
