<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WriteFlow by Ashiful</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6e9cd2;
            --light-bg: #f8f9fa;
            --dark-bg: #1e2124;
            --light-text: #333;
            --dark-text: #f0f0f0;
            --light-container: #ffffff;
            --dark-container: #2c2f33;
            --border-radius: 6px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            --highlight-color: rgba(255, 255, 0, 0.3);
        }

        * {
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: var(--light-bg);
            color: var(--light-text);
        }

        body.night-mode {
            background: var(--dark-bg);
            color: var(--dark-text);
        }

        .container {
            width: 90%;
            max-width: 900px;
            background: var(--light-container);
            padding: 20px;
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            display: flex;
            flex-direction: column;
            height: 90vh;
        }

        body.night-mode .container {
            background: var(--dark-container);
            color: var(--dark-text);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        body.night-mode .header {
            border-bottom: 1px solid #555;
        }

        .title-bar {
            font-size: 22px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .title-bar svg {
            margin-right: 10px;
            fill: var(--primary-color);
        }
        
        .file-tabs {
            display: flex;
            margin-bottom: 5px;
            border-bottom: 1px solid #e0e0e0;
            flex-wrap: wrap;
        }

        .file-tab {
            padding: 8px 12px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            position: relative;
            background: #f1f1f1;
        }

        .file-tab.active {
            background: var(--light-container);
            border-color: #e0e0e0;
            border-bottom: 1px solid var(--light-container);
        }
        
        body.night-mode .file-tab {
            background: #333;
        }
        
        body.night-mode .file-tab.active {
            background: var(--dark-container);
            border-color: #555;
            border-bottom: 1px solid var(--dark-container);
        }

        .file-tab .close-tab {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .button-group {
            display: flex;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        button {
            padding: 8px 12px;
            border: none;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            transition: background 0.2s;
        }

        button:hover {
            background: var(--secondary-color);
        }

        button svg {
            margin-right: 5px;
            width: 16px;
            height: 16px;
        }

        .menu {
            position: relative;
        }

        .menu-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: var(--light-container);
            box-shadow: var(--box-shadow);
            z-index: 10;
            min-width: 180px;
            border-radius: var(--border-radius);
            padding: 8px 0;
        }

        body.night-mode .menu-content {
            background: var(--dark-container);
        }

        .menu:hover .menu-content {
            display: block;
        }

        .menu-content button {
            width: 100%;
            text-align: left;
            background: none;
            color: var(--light-text);
            padding: 10px 15px;
            border-radius: 0;
        }

        body.night-mode .menu-content button {
            color: var(--dark-text);
        }

        .menu-content button:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        body.night-mode .menu-content button:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .editor-container {
            flex: 1;
            position: relative;
            display: flex;
            overflow: hidden;
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
        }

        body.night-mode .editor-container {
            border-color: #555;
        }

        textarea {
            width: 100%;
            height: 100%;
            border: none;
            resize: none;
            font-size: 16px;
            outline: none;
            padding: 15px;
            background: transparent;
            color: inherit;
            overflow: auto;
            line-height: 1.5;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 13px;
            color: #666;
            margin-top: 10px;
        }

        body.night-mode .status-bar {
            color: #aaa;
        }

        .save-section {
            display: none; /* Hidden as file management is now through tabs */
        }

        input {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            font-size: 14px;
            background-color: var(--light-container);
            color: var(--light-text);
        }

        body.night-mode input {
            background-color: var(--dark-container);
            color: var(--dark-text);
            border-color: #555;
        }

        .find-replace-container {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--light-container);
            padding: 15px;
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            z-index: 100;
            width: 350px;
        }

        body.night-mode .find-replace-container {
            background: var(--dark-container);
        }

        .find-replace-container .form-group {
            margin-bottom: 10px;
        }

        .find-replace-container input {
            width: 100%;
            margin-bottom: 10px;
        }

        .find-replace-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 5px;
        }

        .find-replace-buttons button {
            flex: 1;
            min-width: 70px;
        }

        .pdf-preview-modal {
            display: none;
            position: fixed;
            top: 5%;
            left: 5%;
            width: 90%;
            height: 90%;
            background: var(--light-container);
            padding: 20px;
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            z-index: 100;
            flex-direction: column;
        }

        body.night-mode .pdf-preview-modal {
            background: var(--dark-container);
        }

        .pdf-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        body.night-mode .pdf-preview-header {
            border-bottom-color: #555;
        }

        .pdf-preview-content {
            flex: 1;
            overflow: auto;
            border: 1px solid #e0e0e0;
            margin-bottom: 15px;
            padding: 20px;
            background: white;
            color: black;
            display: flex; /* Add flex display */
            flex-direction: column; /* Stack title and body */
            align-items: center; /* Center items horizontally */
        }

        body.night-mode .pdf-preview-content {
            border-color: #555;
        }

        .pdf-preview-title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .pdf-preview-body {
            font-size: 16px;
            line-height: 1.5;
            white-space: pre-wrap;
            text-align: center; /* Center align text in body */
        }

        .pdf-preview-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
        }

        .word-count {
            font-size: 13px;
            color: #666;
        }

        body.night-mode .word-count {
            color: #aaa;
        }

        .scroll-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .scroll-buttons button {
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Line counter styles */
        .editor-container.show-line-numbers {
            display: flex;
        }

        .line-numbers {
            display: none;
            width: 40px;
            padding: 15px 5px;
            background-color: rgba(0, 0, 0, 0.03);
            border-right: 1px solid #e0e0e0;
            text-align: right;
            color: #888;
            font-size: 14px;
            overflow: hidden;
            user-select: none;
        }

        body.night-mode .line-numbers {
            background-color: rgba(255, 255, 255, 0.03);
            border-right-color: #555;
        }

        .editor-container.show-line-numbers .line-numbers {
            display: block;
        }

        .editor-container.show-line-numbers textarea {
            width: calc(100% - 40px);
        }

        /* For text highlighting */
        mark {
            background-color: var(--highlight-color);
            padding: 0;
        }

        /* Print styles */
        @media print {
            body, .container {
                height: auto;
                overflow: visible;
                background: white;
                color: black;
                box-shadow: none;
            }

            .header, .toolbar, .save-section, .scroll-buttons, .status-bar, .menu {
                display: none;
            }

            .editor-container {
                border: none;
                overflow: visible;
                height: auto;
            }

            textarea {
                height: auto;
                white-space: pre-wrap;
                overflow: visible;
                color: black;
            }

            .line-numbers {
                display: none;
            }
        }

        /* Code execution modal */
        .code-execute-modal {
            display: none;
            position: fixed;
            top: 10%;
            left: 10%;
            width: 80%;
            height: 80%;
            background: var(--light-container);
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            z-index: 100;
            flex-direction: column;
            padding: 20px;
        }

        body.night-mode .code-execute-modal {
            background: var(--dark-container);
        }

        .code-execute-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        body.night-mode .code-execute-header {
            border-bottom-color: #555;
        }

        .code-execute-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .code-output {
            flex: 1;
            background: #f5f5f5;
            border-radius: var(--border-radius);
            padding: 15px;
            font-family: monospace;
            overflow: auto;
            white-space: pre-wrap;
            color: black; /* Ensure text color is black */
        }

        body.night-mode .code-output {
            background: #2a2a2a;
            color: lightgray; /* Adjust text color for night mode output */
        }

        .code-execute-footer {
            display: flex;
            justify-content: flex-end;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
        }

        body.night-mode .code-execute-footer {
            border-top-color: #555;
        }

        @media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .button-group {
                width: 100%;
            }

            .save-section {
                flex-direction: column;
                align-items: stretch;
            }

            .container {
                height: 80vh;
                width: 95%;
            }

            .code-execute-modal {
                top: 5%;
                left: 5%;
                width: 90%;
                height: 90%;
            }

            .find-replace-buttons {
                flex-direction: column;
            }
        }
    </style>
    <!-- jsPDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="modal-backdrop" id="modalBackdrop"></div>

    <div class="container">
        <div class="header">
            <div class="title-bar">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                WriteFlow by Ashiful
            </div>
            <div class="menu">
                <button id="menuButton">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="1"></circle>
                        <circle cx="19" cy="12" r="1"></circle>
                        <circle cx="5" cy="12" r="1"></circle>
                    </svg>
                    Features
                </button>
                <div class="menu-content" id="menuOptions">
                    <button onclick="toggleNightMode()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                        Night Mode
                    </button>
                    <button onclick="zoomIn()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            <line x1="11" y1="8" x2="11" y2="14"></line>
                            <line x1="8" y1="11" x2="14" y2="11"></line>
                        </svg>
                        Zoom In
                    </button>
                    <button onclick="zoomOut()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            <line x1="8" y1="11" x2="14" y2="11"></line>
                        </svg>
                        Zoom Out
                    </button>
                    <button onclick="openFindReplace()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        Find & Replace
                    </button>
                    <button onclick="openPdfPreview()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 6 2 18 2 18 9"></polyline>
                            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                            <rect x="6" y="14" width="12" height="8"></rect>
                        </svg>
                        Print as PDF (beta)
                    </button>
                    <button onclick="toggleLineNumbers()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="9" y1="4" x2="20" y2="4"></line>
                            <line x1="9" y1="12" x2="20" y2="12"></line>
                            <line x1="9" y1="20" x2="20" y2="20"></line>
                            <line x1="4" y1="4" x2="4" y2="4"></line>
                            <line x1="4" y1="12" x2="4" y2="12"></line>
                            <line x1="4" y1="20" x2="4" y2="20"></line>
                        </svg>
                        Line Numbers
                    </button>
                    <button onclick="executeCode()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        Execute Code
                    </button>
                    <button onclick="undo()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 7v6h6"></path>
                            <path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path>
                        </svg>
                        Undo
                    </button>
                    <button onclick="redo()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 7v6h-6"></path>
                            <path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7"></path>
                        </svg>
                        Redo
                    </button>
                    <button onclick="speakText()" id="speakButton">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                        </svg>
                        Text to Speech
                    </button>
                </div>
            </div>
        </div>

        <div class="toolbar">
            <div class="button-group">
                <button onclick="saveFile()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Save
                </button>
                <button onclick="openFileDialog()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="12" y1="18" x2="12" y2="12"></line>
                        <line x1="9" y1="15" x2="15" y2="15"></line>
                    </svg>
                    Open
                </button>
                 <button onclick="newFile()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                       <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                       <polyline points="14 2 14 8 20 8"></polyline>
                       <line x1="12" y1="18" x2="12" y2="12"></line>
                       <line x1="9" y1="15" x2="15" y2="15"></line>
                    </svg>
                    New File
                </button>
            </div>

            <div class="button-group">
                <button onclick="clearEditor()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    Clear
                </button>
            </div>
        </div>
        
        <div class="file-tabs" id="fileTabs"></div>


        <div class="save-section">
            <input type="text" id="fileName" placeholder="File name" value="Untitled">
            <input type="text" id="fileExt" placeholder="Extension" value="txt" style="width: 80px;">
        </div>

        <div class="editor-container" id="editorContainer">
            <div class="line-numbers" id="lineNumbers"></div>
            <textarea id="editor" oninput="updateStats()" placeholder="Start typing here..." onscroll="syncScroll()"></textarea>
        </div>

        <div class="scroll-buttons">
            <button onclick="scrollUp()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="18 15 12 9 6 15"></polyline>
                </svg>
                Scroll Up
            </button>
            <button onclick="scrollDown()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
                Scroll Down
            </button>
        </div>

        <div class="status-bar">
            <div class="word-count" id="wordCount">Words: 0 | Characters: 0 | Lines: 0</div>
            <div>Press Ctrl+S to save</div>
        </div>
    </div>

    <div class="find-replace-container" id="findReplace">
        <div class="form-group">
            <input type="text" id="findText" placeholder="Find text">
        </div>
        <div class="form-group">
            <input type="text" id="replaceText" placeholder="Replace with">
        </div>
        <div class="find-replace-buttons">
            <button onclick="findText()">Find</button>
            <button onclick="findNext()">Next</button>
            <button onclick="findPrevious()">Previous</button>
            <button onclick="replaceText()">Replace</button>
            <button onclick="replaceAllText()">Replace All</button>
            <button onclick="closeFindReplace()">Close</button>
        </div>
    </div>

    <div class="pdf-preview-modal" id="pdfPreviewModal">
        <div class="pdf-preview-header">
            <h3>PDF Preview</h3>
            <button onclick="closePdfPreview()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="pdf-preview-content" id="pdfPreviewContent">
            <div class="pdf-preview-title" id="pdfTitle">Title</div>
            <div class="pdf-preview-body" id="pdfBody">Content will appear here</div>
        </div>
        <div class="pdf-preview-footer">
            <button onclick="downloadPdf()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Download PDF
            </button>
            <button onclick="printPdf()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="6 9 6 2 18 2 18 9"></polyline>
                    <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                    <rect x="6" y="14" width="12" height="8"></rect>
                </svg>
                Print PDF
            </button>
        </div>
    </div>

    <div class="code-execute-modal" id="codeExecuteModal">
        <div class="code-execute-header">
            <h3>Code Execution</h3>
            <button onclick="closeCodeExecuteModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="code-execute-content">
            <div class="code-output" id="codeOutput">Executing code...</div>
        </div>
        <div class="code-execute-footer">
            <button onclick="closeCodeExecuteModal()">Close</button>
        </div>
    </div>

    <!-- Hidden file input for opening files -->
    <input type="file" id="fileInput" style="display: none" multiple>

    <script>
        const editor = document.getElementById('editor');
        const fileTabsContainer = document.getElementById('fileTabs');
        const fileName = document.getElementById('fileName');
        const fileExt = document.getElementById('fileExt');
        const modalBackdrop = document.getElementById('modalBackdrop');
        const findReplaceDialog = document.getElementById('findReplace');
        const codeExecuteModal = document.getElementById('codeExecuteModal');
        const pdfPreviewModal = document.getElementById('pdfPreviewModal');
        const pdfPreviewContent = document.getElementById('pdfPreviewContent');
        const pdfTitleElement = document.getElementById('pdfTitle');
        const pdfBodyElement = document.getElementById('pdfBody');
        const wordCountElement = document.getElementById('wordCount');
        const codeOutputElement = document.getElementById('codeOutput');
        const lineNumbersElement = document.getElementById('lineNumbers'); // Get lineNumbers element

        const fileInput = document.getElementById('fileInput');
        let currentFontSize = 16;
        let undoStack = [];
        let redoStack = [];
        let currentFindIndex = -1;
        let findResults = [];
        let lineNumbersEnabled = false;
        let isSpeaking = false;
        
        let files = {};
        let activeFile = null;

        // Initialize with a single text file
        function initializeDefaultFile() {
            files = {
                "text.txt": {
                    content: `Welcome to WriteFlow! Start typing here.`,
                    extension: "txt"
                }
            };
            activeFile = "text.txt";
            renderFileTabs();
            switchFile("text.txt");
        }


        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            initializeDefaultFile();
            updateStats();

            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Ctrl+S to save
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    saveFile();
                }

                // Ctrl+O to open
                if (e.ctrlKey && e.key === 'o') {
                    e.preventDefault();
                    openFileDialog();
                }

                // Ctrl+Z to undo
                if (e.ctrlKey && e.key === 'z') {
                    e.preventDefault();
                    undo();
                }

                // Ctrl+Y to redo
                if (e.ctrlKey && e.key === 'y') {
                    e.preventDefault();
                    redo();
                }

                // Ctrl+F to find
                if (e.ctrlKey && e.key === 'f') {
                    e.preventDefault();
                    openFindReplace();
                }
                 // Ctrl+P to print
                if (e.ctrlKey && e.key === 'p') {
                    e.preventDefault();
                    printDocument();
                }
            });
        });

        // Attach change listener to file input
        fileInput.addEventListener('change', openFile);

        editor.addEventListener('input', function() {
            if (activeFile) {
                files[activeFile].content = editor.value;
            }
            saveToUndoStack();
            updateStats();
            updateLineNumbers(); // Update line numbers on input
        });
        
        function renderFileTabs() {
            fileTabsContainer.innerHTML = '';
            for (const filename in files) {
                const tab = document.createElement('div');
                tab.className = 'file-tab';
                if (filename === activeFile) {
                    tab.classList.add('active');
                }
                tab.textContent = filename;
                tab.onclick = () => switchFile(filename);

                const closeButton = document.createElement('span');
                closeButton.className = 'close-tab';
                closeButton.innerHTML = '&times;';
                closeButton.onclick = (e) => {
                    e.stopPropagation();
                    closeFile(filename);
                };
                tab.appendChild(closeButton);
                fileTabsContainer.appendChild(tab);
            }
        }
        
        function switchFile(filename) {
            if (activeFile && files[activeFile]) {
                files[activeFile].content = editor.value;
            }
            activeFile = filename;
            editor.value = files[filename].content;
            const nameParts = filename.split('.');
            fileExt.value = files[filename].extension;
            fileName.value = nameParts.length > 1 ? nameParts.slice(0, -1).join('.') : filename;
            
            renderFileTabs();
            updateStats();
            updateLineNumbers();
        }
        
        function newFile() {
            const filename = prompt("Enter new filename (e.g., index.html):");
            if (filename && !files[filename]) {
                const nameParts = filename.split('.');
                const extension = nameParts.length > 1 ? nameParts.pop() : 'txt';
                files[filename] = { content: '', extension: extension };
                switchFile(filename);
            } else if (files[filename]) {
                alert("File already exists.");
            }
        }
        
        function closeFile(filename) {
            if (Object.keys(files).length <= 1) {
                alert("Cannot close the last file.");
                return;
            }
            delete files[filename];
            if (activeFile === filename) {
                activeFile = Object.keys(files)[0];
                 switchFile(activeFile);
            }
            renderFileTabs();
        }

        // Functions
        function updateStats() {
            const text = editor.value;
            const wordCount = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
            const charCount = text.length;
            const lineCount = text.split('\n').length;

            wordCountElement.textContent = `Words: ${wordCount} | Characters: ${charCount} | Lines: ${lineCount}`;
        }

        function saveToUndoStack() {
            if (undoStack.length === 0 || editor.value !== undoStack[undoStack.length - 1]) {
                undoStack.push(editor.value);
                // Limit stack size
                if (undoStack.length > 50) {
                    undoStack.shift();
                }
                redoStack = [];
            }
        }

        function undo() {
            if (undoStack.length > 1) {
                redoStack.push(undoStack.pop());
                editor.value = undoStack[undoStack.length - 1];
                updateStats();
                updateLineNumbers(); // Update line numbers on undo
            }
        }

        function redo() {
            if (redoStack.length > 0) {
                const state = redoStack.pop();
                undoStack.push(state);
                editor.value = state;
                updateStats();
                updateLineNumbers(); // Update line numbers on redo
            }
        }

        function saveFile() {
             if (!activeFile) return;

            const content = files[activeFile].content;
            const fullName = activeFile;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = fullName;
            a.click();

            URL.revokeObjectURL(url);
        }

        function openFileDialog() {
            fileInput.click();
        }

        function openFile(event) {
            const fileList = event.target.files;
            if (!fileList.length) return;

            for (const file of fileList) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    const filename = file.name;
                    
                    const nameParts = filename.split('.');
                    const ext = nameParts.length > 1 ? nameParts[nameParts.length - 1] : 'txt';

                    files[filename] = { content: content, extension: ext };
                    switchFile(filename); // Switch to the last opened file
                };
                reader.readAsText(file);
            }

            // Reset file input to allow opening the same file again
            fileInput.value = '';
        }

        function clearEditor() {
            if (confirm('Are you sure you want to clear the editor? All content in the active file will be lost.')) {
                editor.value = '';
                if(activeFile) files[activeFile].content = '';
                saveToUndoStack();
                updateStats();
                updateLineNumbers();
            }
        }

        function toggleNightMode() {
            document.body.classList.toggle('night-mode');
        }

        function zoomIn() {
            currentFontSize += 2;
            editor.style.fontSize = currentFontSize + 'px';
            updateLineNumbers();
        }

        function zoomOut() {
            if (currentFontSize > 8) {
                currentFontSize -= 2;
                editor.style.fontSize = currentFontSize + 'px';
                updateLineNumbers();
            }
        }

        function scrollUp() {
            editor.scrollTop -= 100;
        }

        function scrollDown() {
            editor.scrollTop += 100;
        }

        // Function to sync scroll positions
        function syncScroll() {
            lineNumbersElement.scrollTop = editor.scrollTop;
        }

        // Find and Replace functions
        function openFindReplace() {
            findReplaceDialog.style.display = 'block';
            modalBackdrop.style.display = 'block';
            document.getElementById('findText').focus();
        }

        function closeFindReplace() {
            findReplaceDialog.style.display = 'none';
            modalBackdrop.style.display = 'none';
            clearHighlights();
        }

        function findText() {
            const text = editor.value;
            const searchTerm = document.getElementById('findText').value;
            if (!searchTerm) return;
            findResults = [];
            currentFindIndex = -1;
            let index = text.indexOf(searchTerm);
            while (index !== -1) {
                findResults.push(index);
                index = text.indexOf(searchTerm, index + 1);
            }
            if (findResults.length > 0) findNext();
            else alert('No matches found');
        }

        function findNext() {
            if (findResults.length === 0) { findText(); return; }
            currentFindIndex = (currentFindIndex + 1) % findResults.length;
            highlightFind();
        }

        function findPrevious() {
            if (findResults.length === 0) { findText(); return; }
            currentFindIndex = (currentFindIndex - 1 + findResults.length) % findResults.length;
            highlightFind();
        }

        function highlightFind() {
            const index = findResults[currentFindIndex];
            const searchTerm = document.getElementById('findText').value;
            editor.focus();
            editor.setSelectionRange(index, index + searchTerm.length);
            const lineHeight = parseInt(getComputedStyle(editor).lineHeight);
            const lines = editor.value.substr(0, index).split('\n').length - 1;
            editor.scrollTop = lines * lineHeight;
        }

        function replaceText() {
            if (findResults.length === 0 || currentFindIndex === -1) { findText(); return; }
            const searchTerm = document.getElementById('findText').value;
            const replaceTerm = document.getElementById('replaceText').value;
            const index = findResults[currentFindIndex];

            editor.value = editor.value.substring(0, index) + replaceTerm + editor.value.substring(index + searchTerm.length);
            if (activeFile) files[activeFile].content = editor.value;

            findText(); // Re-run find to update indices
        }

        function replaceAllText() {
            const searchTerm = document.getElementById('findText').value;
            const replaceTerm = document.getElementById('replaceText').value;
            if (!searchTerm) return;
            const originalText = editor.value;
            const newText = originalText.split(searchTerm).join(replaceTerm);
            editor.value = newText;
            if (activeFile) files[activeFile].content = editor.value;
            saveToUndoStack();
            updateStats();
            updateLineNumbers();
            alert(`Replaced all occurrences of "${searchTerm}".`);
            findResults = [];
            currentFindIndex = -1;
        }

        function clearHighlights() {
            // Placeholder for future implementation
        }

        // Code execution (functional)
        function executeCode() {
            if (!activeFile) return;

            const fileExt = files[activeFile].extension;
            const output = document.getElementById('codeOutput');
            
            document.getElementById('codeExecuteModal').style.display = 'flex';
            document.getElementById('modalBackdrop').style.display = 'block';

            if (fileExt === 'html') {
                let content = files[activeFile].content;

                // Inject linked CSS files
                content = content.replace(/<link.*?href="(.+?)"/g, (match, cssFile) => {
                    if (files[cssFile] && files[cssFile].extension === 'css') {
                        return `<style>${files[cssFile].content}<\/style>`;
                    }
                    return match; // Keep link if file not found
                });

                // Inject linked JS files
                content = content.replace(/<script.*?src="(.+?)"/g, (match, jsFile) => {
                    if (files[jsFile] && files[jsFile].extension === 'js') {
                        return `<script>${files[jsFile].content}<\/script>`;
                    }
                    return match; // Keep script tag if file not found
                });
                
                const sandbox = document.createElement('iframe');
                sandbox.style.width = '100%';
                sandbox.style.height = '100%';
                sandbox.style.border = 'none';

                output.innerHTML = '';
                output.appendChild(sandbox);

                sandbox.contentDocument.open();
                sandbox.contentDocument.write(content);
                sandbox.contentDocument.close();

            } else if (fileExt === 'js' || fileExt === 'javascript') {
                try {
                    const content = files[activeFile].content;
                    const sandbox = document.createElement('iframe');
                    sandbox.style.display = 'none';
                    document.body.appendChild(sandbox);

                    let consoleOutput = [];
                    const originalConsole = sandbox.contentWindow.console;
                    sandbox.contentWindow.console = {
                        log: (...args) => { consoleOutput.push(args.join(' ')); originalConsole.log(...args); },
                        error: (...args) => { consoleOutput.push('ERROR: ' + args.join(' ')); originalConsole.error(...args); },
                        warn: (...args) => { consoleOutput.push('WARNING: ' + args.join(' ')); originalConsole.warn(...args); },
                        info: (...args) => { consoleOutput.push(args.join(' ')); originalConsole.info(...args); }
                    };
                    
                    const script = sandbox.contentDocument.createElement('script');
                    script.textContent = content;
                    sandbox.contentDocument.body.appendChild(script);

                    setTimeout(() => {
                        output.innerText = consoleOutput.length > 0 ? consoleOutput.join('\n') : "Code executed successfully. No console output.";
                        document.body.removeChild(sandbox);
                    }, 100);
                } catch (e) {
                    output.innerText = "Error: " + e.message;
                }
            } else {
                output.innerText = `Direct execution for '.${fileExt}' files is not supported in this browser environment. You can still use the editor to write and save your code.`;
            }
        }

        function closeCodeExecuteModal() {
            document.getElementById('codeExecuteModal').style.display = 'none';
            document.getElementById('modalBackdrop').style.display = 'none';
        }

        // Print preview functions
        function openPdfPreview() {
            pdfPreviewModal.style.display = 'flex';
            modalBackdrop.style.display = 'block';
            updatePdfPreview();
        }

        function updatePdfPreview() {
            const content = editor.value;
            const title = activeFile || 'Untitled';
            pdfTitleElement.textContent = title;
            pdfBodyElement.textContent = content;
        }

        function closePdfPreview() {
            pdfPreviewModal.style.display = 'none';
            modalBackdrop.style.display = 'none';
        }

        function printPdf() {
             generatePdfAndOpen();
        }

        function downloadPdf() {
            generatePdfAndDownload();
        }

        function generatePdfAndOpen() {
            const { jsPDF } = window.jspdf;
            const content = editor.value;
            const title = activeFile || 'Untitled';
            const pdfDoc = new jsPDF();
            
            pdfDoc.setFontSize(18);
            pdfDoc.text(title, pdfDoc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });

            pdfDoc.setFontSize(12);
            const margin = 20;
            const textLines = pdfDoc.splitTextToSize(content, pdfDoc.internal.pageSize.getWidth() - 2 * margin);
            pdfDoc.text(textLines, margin, 40);

            const pdfDataUri = pdfDoc.output('datauristring');
            let printWindow = window.open(pdfDataUri);
            printWindow.onload = () => printWindow.print();
        }


        function generatePdfAndDownload() {
            const { jsPDF } = window.jspdf;
            const content = editor.value;
            const title = activeFile || 'Untitled';
            const pdfDoc = new jsPDF();
           
            pdfDoc.setFontSize(18);
            pdfDoc.text(title, pdfDoc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });

            pdfDoc.setFontSize(12);
            const margin = 20;
            const textLines = pdfDoc.splitTextToSize(content, pdfDoc.internal.pageSize.getWidth() - 2 * margin);
            pdfDoc.text(textLines, margin, 40);

            pdfDoc.save(`${fileName.value || 'document'}.pdf`);
        }


    function printDocument() {
         openPdfPreview();
    }

    function toggleLineNumbers() {
        lineNumbersEnabled = !lineNumbersEnabled;
        document.getElementById('editorContainer').classList.toggle('show-line-numbers', lineNumbersEnabled);
        updateLineNumbers();
    }

    function updateLineNumbers() {
        if (!lineNumbersEnabled) {
            lineNumbersElement.innerHTML = '';
            return;
        }
        const lines = editor.value.split('\n').length;
        lineNumbersElement.innerHTML = Array.from({length: lines}, (_, i) => i + 1).join('<br>');
        lineNumbersElement.scrollTop = editor.scrollTop;
    }

    function speakText() {
        const text = editor.value;
        const speakButton = document.getElementById('speakButton');
        if (!('speechSynthesis' in window)) {
            alert('Sorry, your browser does not support text-to-speech.');
            return;
        }
        if (isSpeaking) {
            window.speechSynthesis.cancel();
            return;
        }
        if (text.trim() === '') {
            alert('There is no text to speak.');
            return;
        }
        const utterance = new SpeechSynthesisUtterance(text);
        const resetBtn = () => {
             isSpeaking = false;
             speakButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                </svg>
                Text to Speech`;
        }
        utterance.onstart = () => {
            isSpeaking = true;
            speakButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="6" y="6" width="12" height="12"></rect>
                </svg>
                Stop Speaking`;
        };
        utterance.onend = resetBtn;
        utterance.onerror = (event) => {
            alert('An error occurred during speech synthesis: ' + event.error);
            resetBtn();
        };
        window.speechSynthesis.speak(utterance);
    }

</script>
</body>
</html>